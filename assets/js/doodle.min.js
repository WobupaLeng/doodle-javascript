/*****************************
 * @AUTHOR: NISAL
*****************************/
var doodle={url:"ws://i.tunnel.moeou.com:7451/test",audioUrl:{getScore:"./assets/audio/getPoint.ogg",error:"./assets/audio/err.wav",btnClick:"./assets/audio/btnClick.wav",ready:"./assets/audio/ready.ogg",unReady:"./assets/audio/unReady.ogg",exitRoom:"./assets/audio/exitRoom.wav",time15:"./assets/audio/time15.wav",timesOver:"./assets/audio/timesOver.wav",taunt:"./assets/audio/taunt.wav",encourage:"./assets/audio/encourage.wav",nisal:"./assets/audio/nisal.wav"},drawData:[],drawDataCount:0,canvas:null,cxt:null,lineColor:"#000",lineWidth:7,socket:null,playerName:null,playerId:null,roomId:null,playerCount:null,isInRoom:false,playerList:{},isMyTurn:false,isPlaying:false,curPainter:null,timer:null,tipsCount:0,tipsQueue:[],waitToDeleteTipsQueue:[],tipsColor:[],timerFlag:true,isAnswered:false,whichRoom:0,isNisaling:false,encourage:function(b){var a=this;$("#encourage").click(function(){$(this).attr("disabled","disabled");$("#taunt").attr("disabled","disabled");a.sendMsg("ROOMCHAT#JUDGEEVENTDATA|encourage|"+a.curPainter)})},swChatRoom:function(){var a=this;function b(){$("#haveMsg0").css("display","none");$("#haveMsg1").css("display","none");$(".chgChatRoom").removeClass("active");$(this).addClass("active");var d=$(this).val()==="0"?".chatRoom0":".chatRoom1";var c=".chatRoom"+($(this).val()==="0"?"1":"0");$(c).addClass("animated flipOutX");$(d).css("display","block");$(d).addClass("animated flipInX");a.whichRoom=parseInt($(this).val());setTimeout(function(){$(c).removeClass("animated flipOutX");$(c).css("display","none");$(d).removeClass("animated flipInX")},1000);$(".chgChatRoom").off();setTimeout(function(){a.swChatRoom()},1000)}$(".chgChatRoom").click(b)},taunt:function(b){var a=this;$("#taunt").click(function(){$(this).attr("disabled","disabled");$("#encourage").attr("disabled","disabled");a.sendMsg("ROOMCHAT#JUDGEEVENTDATA|taunt|"+a.curPainter)})},initAudio:function(){for(var a in this.audioUrl){var b=new Audio(this.audioUrl[a]);(function(c){setTimeout(function(){delete c},5000)})(b)}},initTipsColor:function(a){this.tipsColor.push("#FFE4E1");this.tipsColor.push("#FFB6C1");this.tipsColor.push("#FF8C00");this.tipsColor.push("#FF1493");this.tipsColor.push("#FA8072");this.tipsColor.push("#F5DEB3");this.tipsColor.push("#F4A460");this.tipsColor.push("#E9967A");this.tipsColor.push("#DC143C");this.tipsColor.push("#DA70D6");this.tipsColor.push("#CD5C5C");this.tipsColor.push("#AFEEEE");this.tipsColor.push("#9932CC");this.tipsColor.push("#8A2BE2");this.tipsColor.push("#87CEEB");this.tipsColor.push("#3CB371");this.tipsColor.push("#00CED1");this.tipsColor.push("#FF7F50");this.tipsColor.push("#E0FFFF");this.tipsColor.push("#DEB887");this.tipsColor.push("#DDA0DD")},showTips:function(e,d){var b=this;var a=$("<div></div>");var c=$("<span></span>");c.html(e);c.addClass("tipContent");c.css("background-color",this.tipsColor[parseInt(Math.random()*this.tipsColor.length)]);a.addClass("tips tips"+this.tipsCount);a.append(c);a.css("display","none");$("#tipsWarpper").append(a);a.css("display","block");$(".tips"+this.tipsCount).css("display","block");$(".tips"+this.tipsCount).addClass("animated bounceIn");this.tipsQueue.unshift(".tips"+this.tipsCount);this.tipsCount++;setTimeout(function(){$(b.tipsQueue[b.tipsQueue.length-1]).removeClass("animated bounceIn");$(b.tipsQueue[b.tipsQueue.length-1]).addClass("animated bounceOut");b.waitToDeleteTipsQueue.unshift(b.tipsQueue.pop());setTimeout(function(){$(b.waitToDeleteTipsQueue[0]).remove();b.waitToDeleteTipsQueue.shift()},1000);this.tipsCount--},d)},setLineWidth:function(b){var a=this;$("#setLineWidth").change(function(){a.lineWidth=$(this).val();$("#rangeNum").html($(this).val())})},socketEroor:function(){var a=this;this.socket.onerror=function(b){alert.html("组织上好像出现了什么错误...")}},socketClose:function(){var a=this;this.socket.onclose=function(b){alert("组织把你抛下不管了...")}},setErrorAnimate:function(a){$(a).addClass("animated shake");this.audio("error");setTimeout(function(){$(a).removeClass("animated shake")},1000)},exitTheRoom:function(b){var a=this;$("#exitRoom").click(function(){if(a.isInRoom){a.audio("exitRoom");$("#setRoomNumber").off("click");$("#roomNumber").off("keypress");$("#roomSelector").removeClass("animated bounceOut");$("#roomSelectorWarpper").removeClass("animated bounceOut");$("#drawBoardWarpper").removeClass("animated bounceIn");$("#roomSelectorWarpper").css("display","block");$("#roomSelectorWarpper").addClass("animated bounceIn");$("#drawBoardWarpper").addClass("animated bounceOut");a.isInRoom=false;a.sendMsg("EXIT#1");a.playerList={};$(".user").remove();setTimeout(function(){$("#drawBoardWarpper").css("z-index","10");$("#drawBoardWarpper").css("display","none");$("#roomNumber").focus()},200);setTimeout(function(){a.enterRoom()},900)}})},setName:function(b){var a=this;function c(){if($("#playerName").val()===""){$("#setNameAlert").html("DALAO们就是喜欢用null做名字_(:°з」∠)_");a.setErrorAnimate("#setNameAlert");return}if($("#playerName").val().length>7){$("#setNameAlert").html("这个...名字还是短一点 比较好吧 七个字差不多了吧");a.setErrorAnimate("#setNameAlert");return}if($("#playerName").val().match("#")||$("#playerName").val().match("<")||$("#playerName").val().match(">")){$("#setNameAlert").html("你看我这记性.. # > < 这三个符号 也是不能出现的 不利于谈笑风生");a.setErrorAnimate("#setNameAlert")}if(a.playerId!=="undefined"&&a.playerId!==null){a.audio("btnClick");a.sendMsg("SETNAME#"+$("#playerName").val());a.playerName=$("#playerName").val();$("#setNamePanel").removeClass("animated bounceIn");$("#setNamePanel").addClass("animated bounceOut");setTimeout(function(){$("#roomSelectorWarpper").css("display","block");$("#setNamePanel").addClass("animated bounceIn");$("#roomNumber").focus()},200);setTimeout(function(){$("#setNameWarpper").empty()},1000)}}$("#setNameBtn").click(c);$("#playerName").keypress(function(d){if(d.keyCode===13){c()}});$("#playerName").keyup(function(){localStorage.playerName=$(this).val()})},chat:function(c){var b=this;function a(){var d=$("#sendMsg").val();if(d===""){return}if(d.match("#")){return}if(d==="/clear"){$(".chatRoom"+b.whichRoom).empty();$("#sendMsg").val("");return}if(!b.whichRoom){b.sendMsg("ROOMCHAT#"+d);$("#sendMsg").val("");return}b.sendMsg("SERVERCHAT#"+d);$("#sendMsg").val("")}$("#sendMsgBtn").click(a);$("#sendMsg").keypress(function(d){if(d.keyCode===13){a()}})},enterRoomByRand:function(b){var a=this;$("#joinRoomByRand").click(function(){a.audio("btnClick");a.sendMsg("JOIN#"+parseInt(Math.random()*10000000).toString())})},enterRoom:function(c){var b=this;function a(){var d=$("#roomNumber").val();if(d===""){$("#setRoomAlert").html("DALAO们就是喜欢去不存在的地方溜溜 ♪（´∀｀●）ﾉｼ");b.setErrorAnimate("#setRoomAlert");return}if(d.length>8){$("#setRoomAlert").html("太..太长了..这个不行");b.setErrorAnimate("#setRoomAlert");return}for(var e=0;e<d.length;e++){if(!(d[e]>="0"&&d[e]<=9)){$("#setRoomAlert").html("说好了只能是数字的");b.setErrorAnimate("#setRoomAlert");return}}if(!b.isInRoom){b.audio("btnClick");$("#chatBody").empty();b.sendMsg("JOIN#"+d);b.chatFormat(['<span style="color: #f00;">系统提示</span>',"/clear可以清空框框"],0);return}$("#setRoomAlert").html("你没干啥吧。。发生了奇怪的错误");b.setErrorAnimate("#setRoomAlert")}$("#setRoomNumber").click(a);$("#roomNumber").keypress(function(d){if(d.keyCode===13){a()}})},audio:function(a){var b=new Audio(this.audioUrl[a]);b.play();(function(c){setTimeout(function(){delete c},5000)})(b)},ready:function(b){var a=this;$("#ready").click(function(){a.sendMsg("READY#"+$(this).val());if($(this).val()==="1"){$(this).html("取消准备");$(this).val("0");a.audio("ready");return}$(this).html("准备");$(this).val("1");a.audio("unReady")})},initWebSocket:function(a){this.socket=new WebSocket(this.url);this.socket.onopen=function(b){$("#socketLog").html("连接成功")}},sendMsg:function(a){this.socket.send(">>"+a+"<<")},getMsg:function(b){var a=this;this.socket.onmessage=function(r){var t=r.data.split("#");var f=t[0].replace(">>","");t[t.length-1]=t[t.length-1].replace("<<","");switch(f){case"AGENTID":a.playerId=t[1];break;case"ROOM":$("#judgeWarpper").addClass("animated bounceOut");setTimeout(function(){$("#judgeWarpper").removeClass("animated bounceOut");$("#judgeWarpper").css("display","none")},1000);a.isPlaying=false;a.clear();$("#exitRoom").removeAttr("disabled");$("#quesTitle").html("题目 & 答案");clearInterval(a.timer);$("#ready").html("准备");$("#ready").removeAttr("disabled");$("#ready").val("1");$(".state").html('<span style="color: #f00">未准备</span>');a.roomId=t[1];a.isInRoom=true;$("#playersArea .title .exitRoomTitle").html("RID:"+a.roomId);$("#drawBoardWarpper").removeClass("animated bounceOut");$("#roomSelector").removeClass("animated bounceIn");$("#roomSelector").addClass("animated bounceOut");setTimeout(function(){$("#drawBoardWarpper").css("display","block");$("#drawBoardWarpper").css("z-index","15");$("#drawBoardWarpper").addClass("animated bounceIn")},200);setTimeout(function(){$("#roomSelectorWarpper").css("display","none")},1000);break;case"PLAYER":var i=t[1].split("|");var o=0;var v=$("<div></div>");var g=$("<div></div>");var s=$("<div></div>");var k=$("<div></div>");var q=$("<div></div>");var h=$("<div></div>");if(a.isPlaying){return}if(a.playerList[i[0]]){$("."+"score"+a.playerList[i[0]].id).html(i[3]);$("."+"state"+a.playerList[i[0]].id).html(i[4]==="0"?'<span style="color: #f00">未准备</span>':'<span style="color: #27ae60">准备</span>');return}v.addClass("user user"+i[0]);g.addClass("left");s.addClass("right");k.addClass("info playerName "+"id"+i[0]);q.addClass("info "+"score"+i[0]);h.addClass("info state "+"state"+i[0]);var d=(i[2].toUpperCase()==="MICOYA"?'<img src="./assets/images/micoya.jpg" alt="">':'<img src="./assets/images/'+parseInt(Math.random()*12+1)+'.png" alt="">');g.html(d);k.html(i[2]);q.html(i[3]);h.html(i[4]==="0"?'<span style="color: #f00">未准备</span>':'<span style="color: #27ae60">准备</span>');s.append(k,q,h);v.append(g,s);a.playerList[i[0]]={id:i[0],name:i[2],score:i[3],state:i[4]};a.showTips(i[2]+" 进入了房间",2000);a.chatFormat(['<span style="color: #f00;">系统提示</span>',i[2]+" 进入了房间",0]);$("#drawBoardWarpper #drawBoard #playersArea").append(v);break;case"ERROR":if(!a.isInRoom){if(t[1]==="房间已开始游戏，请稍后加入"){$("#setRoomAlert").html("有老板在里面谈笑风生");a.setErrorAnimate("#setRoomAlert");return}$("#setRoomAlert").html("老板..里面6P..咳咳...6Player了");a.setErrorAnimate("#setRoomAlert")}break;case"DRAW":var m=JSON.parse(t[1]);if(m.clear){a.clear();return}if(m.painter===a.playerId){return}if(m.firstPoint){a.cxt.beginPath();a.cxt.moveTo(m.x,m.y)}a.cxt.lineWidth=m.lineWidth;a.cxt.strokeStyle="#"+m.lineColor;a.cxt.lineTo(m.x,m.y);a.cxt.stroke();if(m.state){a.cxt.closePath()}break;case"PAINT":a.clear();a.isPlaying=true;a.curPainter=t[1].toString();$("#ready").html("游戏中");$(".state").html('<span style="color: #27ae60">等待</span>');$(".state"+t[1].toString()).html('<span style="color: #f00">画画中</span>');if(a.playerId!==t[1].toString()){$("#canvas").css("z-index","-1");a.isMyTurn=false;break}a.isMyTurn=true;a.showTips("轮到你画了",2000);$("#canvas").css("z-index",$("#drawBoardWarpper").css("z-index"));break;case"SETGAMESTATE":$("#judgeWarpper").addClass("animated bounceOut");setTimeout(function(){$("#judgeWarpper").removeClass("animated bounceOut");$("#judgeWarpper").css("display","none")},1000);$("#taunt").removeAttr("disabled");$("#encourage").removeAttr("disabled");a.isAnswered=false;a.timerFlag=true;$("#exitRoom").attr("disabled","disabled");$("#ready").attr("disabled","disabled");$("#quesTitle").html("");var u=t[1].split("|");var j=parseInt(u[1]);a.timer=setInterval(function(){if(a.timerFlag&&!(a.isAnswered)&&j<16){a.showTips("这一轮还有十五秒 抓紧时间！",1500);a.chatFormat(['<span style="color: #f00;">系统提示</span>',"这一轮还有十五秒 抓紧时间！"],0);a.audio("time15");a.timerFlag=false}$("#clock").html(j);j--;if(j<0){clearInterval(a.timer)}},1000);a.showTips("新的一轮开始了",1000);break;case"TITLE":a.isMyTurn=true;$("#quesTitle").html(t[1]);break;case"HINT":if(!a.isMyTurn){$("#quesTitle").html($("#quesTitle").html()+"&nbsp;"+t[1])}break;case"SCORE":var p=t[1].split("|");var l=parseInt($(".score"+p[0]).text())+parseInt(p[1]);$(".score"+p[0]).html(l);if(a.isAnswered){a.chatFormat(['<span style="color: #f00;">系统提示</span>',"你已经回答对了！"],0);return}if(a.playerId===p[0]){a.audio("getScore");a.isAnswered=true;a.showTips(a.playerList[p[0]].name+"答对了!",500)}if(a.curPainter===p[0]){a.chatFormat(['<span style="color: #f00;">系统提示</span>',a.playerList[a.curPainter].name+"加1分！"],0);return}a.chatFormat(['<span style="color: #f00;">系统提示</span>',a.playerList[p[0]].name+"答对了！"],0);break;case"ANSWER":$("#quesTitle").html("答案:"+t[1]);a.showTips("答案:"+t[1],4000);break;case"ROOMCHAT":if(a.whichRoom){$("#haveMsg0").css("display","inline")}if(t[1].match("JUDGEEVENTDATA")){var c=t[1].split("|");var n=c[0].split(":");if(c[1]==="encourage"){a.chatFormat(['<span style="color: #f00;">系统提示</span>',n[0]+"对"+a.playerList[c[2]].name+"发起了鼓励"],0);a.audio("encourage");break}a.chatFormat(['<span style="color: #f00;">系统提示</span>',n[0]+"对"+a.playerList[c[2]].name+"发起了嘲讽"],0);a.audio("taunt");break}if(t[1].split(":")[1].toUpperCase().match("NISAL")&&!(a.isNisaling)){a.audio("nisal");a.isNisaling=true;setTimeout(function(){a.isNisaling=false},3000)}a.chatFormat(t[1].split(":"),0);break;case"PLAYEREXIT":a.showTips(a.playerList[t[1]].name+"退出了房间",2000);$(".user"+t[1]).remove();delete a.playerList[t[1]];break;case"TIMEEND":a.showTips("本轮结束！",1000);clearInterval(a.timer);a.audio("timesOver");if(!a.isMyTurn){$("#judgeWarpper").css("display","block");$("#judgeWarpper").addClass("animated bounceIn");setTimeout(function(){$("#judgeWarpper").removeClass("animated bounceIn")},1000)}break;case"SYSTEM":a.chatFormat(['<span style="color: #f00;">系统通知</span>',t[1]],0);a.chatFormat(['<span style="color: #f00;">系统通知</span>',t[1]],1);break;case"SERVERCHAT":a.chatFormat(t[1].split(":"),1);if(!a.whichRoom){$("#haveMsg1").css("display","inline")}break}}},chatFormat:function(e,g){var f=$("<div></div>");var i=$("<div></div>");var c=$("<div></div>");var a=$("<span></span>");var h=$("<span></span>");var b=new Date();var d="&nbsp;&nbsp;"+b.getFullYear()+"/"+b.getMonth()+"/"+b.getDate()+"&nbsp;"+b.getHours()+":"+b.getMinutes()+":"+b.getSeconds();f.addClass("chatBlock");i.addClass("chatInfo");c.addClass("chatContent");a.addClass("name");h.addClass("date");a.html(e[0]);h.html(d);c.html(e[1]);i.append(a,d);f.append(i,c);$(".chatRoom"+g).append(f);$("#chatBody").animate({scrollTop:$("#chatBody")[0].scrollHeight},200);$("#chatBodyCommen").animate({scrollTop:$("#chatBodyCommen")[0].scrollHeight},200)},init:function(){this.setMouseDownEvent();this.clearEve();this.setLineColor();this.initWebSocket();this.getMsg();this.setLineWidth();this.setName();this.enterRoom();this.enterRoomByRand();this.ready();this.chat();this.exitTheRoom();this.initTipsColor();this.encourage();this.taunt();this.initAudio();this.swChatRoom()},setLineColor:function(b){var a=this;$(".paint").click(function(){$(".paint").removeClass("btnActive");$(this).val()==="#fff"?a.canvas.style.cursor="url(./assets/images/earserCursor.png), default":a.canvas.style.cursor="url(./assets/images/mouse.png), default";a.lineColor=$(this).val();$(this).addClass("btnActive")})},clearEve:function(b){var a=this;$("#clear").click(function(){a.sendMsg("DRAW#"+JSON.stringify({clear:true}));a.clear()})},setConfig:function(a){this.canvas=$("#canvas")[0];this.cxt=this.canvas.getContext("2d");this.canvas.width=800;this.canvas.height=600;this.cxt.lineCap="round";this.cxt.lineWidth=7;$("#playerName").focus();$("#setNamePanel").addClass("animated bounceIn");if(localStorage.playerName){$("#playerName").val(localStorage.playerName)}this.chatFormat(['<span style="color: #f00;">系统提示</span>',"/clear可以清空框框"],1)},setMouseDownEvent:function(b){var a=this;$("#canvas").on("mousedown",function(c){a.cxt.beginPath();a.cxt.moveTo(c.pageX-$("#canvas").offset().left,c.pageY-$("#canvas").offset().top);a.sendMsg("DRAW#"+JSON.stringify({x:c.pageX-$("#canvas").offset().left,y:c.pageY-$("#canvas").offset().top,painter:a.playerId,firstPoint:true,lineColor:a.lineColor.replace("#",""),lineWidth:a.lineWidth}));a.drawData[a.drawDataCount]=[];a.drawData[a.drawDataCount].push({x:c.pageX-$("#canvas").offset().left,y:c.pageY-$("#canvas").offset().top});$("#canvas").on("mousemove",function(d){a.cxt.lineTo(d.pageX-$("#canvas").offset().left,d.pageY-$("#canvas").offset().top);a.sendMsg("DRAW#"+JSON.stringify({x:d.pageX-$("#canvas").offset().left,y:d.pageY-$("#canvas").offset().top,painter:a.playerId,lineColor:a.lineColor.replace("#",""),lineWidth:a.lineWidth}));a.drawData[a.drawDataCount].push({x:d.pageX-$("#canvas").offset().left,y:d.pageY-$("#canvas").offset().top});a.cxt.lineWidth=a.lineWidth;a.cxt.strokeStyle=a.lineColor;a.cxt.stroke()});$("#canvas").on("mouseup",function(d){a.cxt.closePath();a.drawDataCount++;a.sendMsg("DRAW#"+JSON.stringify({x:d.pageX-$("#canvas").offset().left,y:d.pageY-$("#canvas").offset().top,state:true,painter:a.playerId,lineColor:a.lineColor.replace("#",""),lineWidth:a.lineWidth}));$("#log").html(a.drawDataCount);$("#canvas").off("mousemove");$("#canvas").off("mouseup")})})},clear:function(a){this.cxt.fillStyle="#000000";this.cxt.beginPath();this.cxt.clearRect(0,0,canvas.width,canvas.height);this.cxt.closePath()}};doodle.setConfig();doodle.init();